<div class="min-h-screen pb-20 bg-slate-900">

    <!-- Compact Header (80px max) -->
    <div class="sticky top-0 z-20 bg-slate-800 px-5 py-4 border-b border-slate-700">
        <div class="flex items-center justify-between">
            <!-- Left: Title + Value -->
            <div>
                <p class="text-xs text-slate-400 uppercase tracking-wide font-medium">Valor Inventario</p>
                <p class="text-3xl font-extrabold text-emerald-400 mt-0.5">
                    {{ formatearMoneda(valorTotalInventario()) }}
                </p>
            </div>

            <!-- Right: Circular Icon Button -->
            <div
                class="flex items-center justify-center w-12 h-12 rounded-full bg-emerald-500/10 border border-emerald-500/20">
                <lucide-icon name="dollar-sign" [size]="24" class="text-emerald-400"></lucide-icon>
            </div>
        </div>
    </div>

    <!-- Search Bar (Sticky) -->
    <div class="sticky top-20 z-10 bg-slate-900 px-5 py-3">
        <div class="relative">
            <lucide-icon name="search" [size]="18"
                class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></lucide-icon>
            <input type="text" placeholder="Buscar insumo..." [value]="busqueda()" (input)="onBusquedaChange($event)"
                class="w-full pl-10 pr-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
        </div>
    </div>

    <!-- Filter Chips (Horizontal Scroll) -->
    <div class="sticky top-32 z-10 bg-slate-900 px-5 py-2 border-b border-slate-800">
        <div class="flex overflow-x-auto gap-2 scrollbar-hide pb-1">

            <!-- Todos -->
            <button (click)="tipoFiltro.set('todos')" [ngClass]="{
                    'bg-emerald-500/10 border-emerald-500 text-white': tipoFiltro() === 'todos',
                    'bg-transparent border-slate-700 text-slate-400': tipoFiltro() !== 'todos'
                }"
                class="flex items-center gap-1.5 px-3 py-1.5 rounded-full border text-xs font-medium whitespace-nowrap transition-all active:scale-95">
                <lucide-icon name="layers" [size]="14" [class.text-emerald-400]="tipoFiltro() === 'todos'"
                    [class.text-slate-500]="tipoFiltro() !== 'todos'"></lucide-icon>
                Todos
            </button>

            <!-- Alimento (Wheat icon) -->
            <button (click)="tipoFiltro.set('alimento')" [ngClass]="{
                    'bg-amber-500/10 border-amber-500 text-white': tipoFiltro() === 'alimento',
                    'bg-transparent border-slate-700 text-slate-400': tipoFiltro() !== 'alimento'
                }"
                class="flex items-center gap-1.5 px-3 py-1.5 rounded-full border text-xs font-medium whitespace-nowrap transition-all active:scale-95">
                <lucide-icon name="wheat" [size]="14" [class.text-amber-400]="tipoFiltro() === 'alimento'"
                    [class.text-slate-500]="tipoFiltro() !== 'alimento'"></lucide-icon>
                Alimento
            </button>

            <!-- Medicamento (Pill icon) -->
            <button (click)="tipoFiltro.set('medicamento')" [ngClass]="{
                    'bg-blue-500/10 border-blue-500 text-white': tipoFiltro() === 'medicamento',
                    'bg-transparent border-slate-700 text-slate-400': tipoFiltro() !== 'medicamento'
                }"
                class="flex items-center gap-1.5 px-3 py-1.5 rounded-full border text-xs font-medium whitespace-nowrap transition-all active:scale-95">
                <lucide-icon name="pill" [size]="14" [class.text-blue-400]="tipoFiltro() === 'medicamento'"
                    [class.text-slate-500]="tipoFiltro() !== 'medicamento'"></lucide-icon>
                Medicamento
            </button>

            <!-- Biológico (Syringe icon) -->
            <button (click)="tipoFiltro.set('biologico')" [ngClass]="{
                    'bg-pink-500/10 border-pink-500 text-white': tipoFiltro() === 'biologico',
                    'bg-transparent border-slate-700 text-slate-400': tipoFiltro() !== 'biologico'
                }"
                class="flex items-center gap-1.5 px-3 py-1.5 rounded-full border text-xs font-medium whitespace-nowrap transition-all active:scale-95">
                <lucide-icon name="syringe" [size]="14" [class.text-pink-400]="tipoFiltro() === 'biologico'"
                    [class.text-slate-500]="tipoFiltro() !== 'biologico'"></lucide-icon>
                Biológico
            </button>

            <!-- Material (Package icon) -->
            <button (click)="tipoFiltro.set('material')" [ngClass]="{
                    'bg-slate-600 border-slate-500 text-white': tipoFiltro() === 'material',
                    'bg-transparent border-slate-700 text-slate-400': tipoFiltro() !== 'material'
                }"
                class="flex items-center gap-1.5 px-3 py-1.5 rounded-full border text-xs font-medium whitespace-nowrap transition-all active:scale-95">
                <lucide-icon name="package" [size]="14" [class.text-slate-300]="tipoFiltro() === 'material'"
                    [class.text-slate-500]="tipoFiltro() !== 'material'"></lucide-icon>
                Material
            </button>

        </div>
    </div>

    <!-- Loading State -->
    @if (loading()) {
    <div class="flex items-center justify-center h-64">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-500 mx-auto"></div>
            <p class="mt-4 text-sm text-slate-300">Cargando inventario...</p>
        </div>
    </div>
    }

    <!-- Error State -->
    @else if (error()) {
    <div class="mx-5 mt-5 bg-red-900/20 border border-red-900/30 rounded-xl p-4">
        <div class="flex items-start">
            <lucide-icon name="alert-triangle" [size]="24" class="text-red-400 mr-3"></lucide-icon>
            <div>
                <h3 class="text-lg font-semibold text-red-400">Error</h3>
                <p class="text-sm text-slate-300 mt-1">{{ error() }}</p>
                <button (click)="cargarInventario()" class="mt-3 text-sm text-red-400 underline hover:text-red-300">
                    Reintentar
                </button>
            </div>
        </div>
    </div>
    }

    <!-- Content -->
    @else {
    <!-- Product List -->
    <div class="p-4 space-y-3">
        @if (inventarioFiltrado().length === 0) {
        <div class="bg-slate-800 rounded-xl p-8 text-center border border-slate-700">
            <lucide-icon name="search-x" [size]="48" class="text-slate-500 mx-auto mb-4"></lucide-icon>
            <p class="text-slate-400">No se encontraron insumos</p>
        </div>
        }

        @for (item of inventarioFiltrado(); track item.id) {
        <div
            class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden transition-all hover:border-slate-600">

            <!-- Collapsed Header (Always Visible) -->
            <div class="p-4 cursor-pointer hover:bg-slate-750 transition-colors"
                (click)="toggleExpand(item.id!, $event)">
                <div class="flex items-center justify-between gap-3">
                    <!-- Left: Icon + Name -->
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <div class="flex items-center justify-center w-12 h-12 rounded-full bg-slate-700 flex-shrink-0">
                            <lucide-icon [name]="getIconoTipo(item.tipo)" [size]="22"
                                class="text-emerald-400"></lucide-icon>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base font-bold text-white truncate">{{ item.nombre }}</h3>
                            <p class="text-xs text-slate-400 capitalize">{{ item.tipo }}</p>
                        </div>
                    </div>

                    <!-- Right: Stock + Chevron -->
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            <p class="text-xs text-slate-400">Stock</p>
                            <p class="text-2xl font-bold" [class.text-red-400]="isStockBajo(item)"
                                [class.text-emerald-400]="!isStockBajo(item)">
                                {{ item.stock_actual || 0 }}
                            </p>
                        </div>
                        <div class="transition-transform duration-200 flex-shrink-0"
                            [class.rotate-180]="isExpanded(item.id!)">
                            <lucide-icon name="chevron-down" [size]="20" class="text-slate-400"></lucide-icon>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expanded Body (Conditional) -->
            @if (isExpanded(item.id!)) {
            <div class="border-t border-slate-700 bg-slate-900 animate-in fade-in slide-in-from-top-2 duration-200">

                <!-- Structured Data Container (Lighter Background) -->
                <div class="m-4 p-4 bg-slate-800/80 rounded-lg border border-slate-700/50">
                    <!-- 2-Column Grid -->
                    <div class="grid grid-cols-2 gap-4">

                        <!-- Row 1 Left: Presentación -->
                        <div>
                            <p class="text-xs text-slate-500 uppercase tracking-wide font-bold mb-1">Presentación</p>
                            <p class="text-sm text-white font-medium">{{ item.presentacion_compra }} {{
                                item.unidad_medida }}</p>
                        </div>

                        <!-- Row 1 Right: Stock Mínimo -->
                        <div>
                            <p class="text-xs text-slate-500 uppercase tracking-wide font-bold mb-1">Stock Mín</p>
                            <p class="text-sm text-white font-medium">{{ item.stock_minimo }}</p>
                        </div>

                    </div>

                    <!-- Horizontal Divider -->
                    <div class="h-px bg-slate-700/50 my-4"></div>

                    <!-- Row 2 -->
                    <div class="grid grid-cols-2 gap-4">

                        <!-- Row 2 Left: Costo Promedio -->
                        <div>
                            <p class="text-xs text-slate-500 uppercase tracking-wide font-bold mb-1">Costo Prom.</p>
                            <p class="text-base text-slate-300 font-semibold">
                                {{ formatearMoneda(item.costo_promedio || 0) }}
                            </p>
                            <p class="text-xs text-slate-400 mt-0.5">/ {{ item.unidad_medida }}</p>
                        </div>

                        <!-- Row 2 Right: Valor Total -->
                        <div>
                            <p class="text-xs text-slate-500 uppercase tracking-wide font-bold mb-1">Valor Total</p>
                            <p class="text-lg text-emerald-400 font-extrabold">
                                {{ formatearMoneda(item.valorTotal) }}
                            </p>
                        </div>

                    </div>
                </div>

                <!-- Stock Low Alert (Bottom of data) -->
                @if (isStockBajo(item)) {
                <div class="mx-4 mb-4 p-2.5 bg-red-900/20 border border-red-900/30 rounded-lg flex items-center gap-2">
                    <lucide-icon name="alert-triangle" [size]="14" class="text-red-400 flex-shrink-0"></lucide-icon>
                    <p class="text-xs text-red-400 font-medium">Stock bajo. Mínimo requerido: {{ item.stock_minimo }}
                    </p>
                </div>
                }

                <!-- Solid Action Button (44px height) -->
                <button (click)="abrirModalAjuste(item); $event.stopPropagation()"
                    class="w-full h-11 bg-emerald-600 hover:bg-emerald-500 text-white font-bold text-sm transition-colors flex items-center justify-center gap-2 group active:scale-[0.98]">
                    <lucide-icon name="edit-3" [size]="16"
                        class="group-hover:rotate-12 transition-transform"></lucide-icon>
                    <span>Realizar Ajuste</span>
                </button>
            </div>
            }
        </div>
        }
    </div>
    }
</div>

<!-- Modal de Ajuste -->
@if (ajusteModalOpen() && insumoSeleccionado()) {
<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" (click)="cerrarModalAjuste()">
    <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-2xl max-w-md w-full"
        (click)="$event.stopPropagation()">
        <!-- Modal Header -->
        <div class="p-6 border-b border-slate-700">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold text-white">Ajuste Manual de Inventario</h2>
                <button (click)="cerrarModalAjuste()" class="text-slate-400 hover:text-white transition-colors">
                    <lucide-icon name="x" [size]="24"></lucide-icon>
                </button>
            </div>
            <p class="text-sm text-slate-400 mt-1">{{ insumoSeleccionado()!.nombre }}</p>
        </div>

        <!-- Modal Body -->
        <form [formGroup]="ajusteForm" (ngSubmit)="guardarAjuste()" class="p-6 space-y-4">
            <!-- Tipo de Ajuste -->
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Tipo de Ajuste</label>
                <select formControlName="tipo"
                    class="w-full bg-slate-700 border border-slate-600 rounded-lg text-white p-3 focus:ring-2 focus:ring-emerald-500 outline-none">
                    <option value="perdida">Pérdida/Daño</option>
                    <option value="entrada">Ajuste Entrada</option>
                </select>
            </div>

            <!-- Cantidad -->
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Cantidad</label>
                <input type="number" formControlName="cantidad" step="0.01" min="0.01" placeholder="0.00"
                    class="w-full bg-slate-700 border border-slate-600 rounded-lg text-white p-3 focus:ring-2 focus:ring-emerald-500 outline-none">
                <p class="text-xs text-slate-400 mt-1">En {{ insumoSeleccionado()!.unidad_medida }}</p>
                @if (ajusteForm.get('cantidad')?.invalid && ajusteForm.get('cantidad')?.touched) {
                <p class="text-xs text-red-400 mt-1">La cantidad es requerida y debe ser mayor a 0</p>
                }
            </div>

            <!-- Nota -->
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Nota (Opcional)</label>
                <textarea formControlName="nota" rows="3" placeholder="Motivo del ajuste..."
                    class="w-full bg-slate-700 border border-slate-600 rounded-lg text-white p-3 focus:ring-2 focus:ring-emerald-500 outline-none resize-none"></textarea>
            </div>

            <!-- Modal Footer -->
            <div class="flex gap-3 pt-4">
                <button type="button" (click)="cerrarModalAjuste()"
                    class="flex-1 px-4 py-3 bg-slate-700 text-white font-semibold rounded-lg hover:bg-slate-600 transition-colors">
                    Cancelar
                </button>
                <button type="submit" [disabled]="ajusteForm.invalid || loadingAjuste()"
                    class="flex-1 px-4 py-3 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    @if (loadingAjuste()) {
                    <span class="flex items-center justify-center">
                        <span class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></span>
                        Guardando...
                    </span>
                    } @else {
                    Guardar Ajuste
                    }
                </button>
            </div>
        </form>
    </div>
</div>
}