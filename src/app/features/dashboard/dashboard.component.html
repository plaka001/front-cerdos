<div class="min-h-screen pb-20" style="background-color: var(--color-bg);">
  <!-- Loading State -->
  @if (loading()) {
  <div class="flex items-center justify-center h-screen">
    <div class="text-center fade-in">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 mx-auto" style="border-color: var(--color-primary);">
      </div>
      <p class="mt-4 text-label">Cargando dashboard...</p>
    </div>
  </div>
  }

  <!-- Error State -->
  @else if (error()) {
  <div class="p-4">
    <div class="card" style="background: var(--color-critical-light); border-color: var(--color-critical);">
      <div class="flex items-start p-4">
        <lucide-icon name="alert-triangle" [size]="24"
          style="color: var(--color-critical); margin-right: 12px;"></lucide-icon>
        <div>
          <h3 class="text-h3" style="color: var(--color-critical-dark);">Error</h3>
          <p class="text-small mt-1">{{ error() }}</p>
          <button (click)="cargarDatos()" class="mt-3 text-small underline" style="color: var(--color-critical);">
            Reintentar
          </button>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Dashboard Content -->
  @else if (dashboardData()) {
  <div class="p-5 space-y-6 fade-in">

    <!-- ========== HEADER SECTION ========== -->
    <div class="mb-6">
      <div class="flex items-center justify-between mb-2">
        <div>
          <h1 class="text-h1">Resumen de la Granja</h1>
          <p class="text-small capitalize" style="color: var(--color-text-secondary);">{{ fechaActual }}</p>
        </div>
        <div class="flex items-center gap-2">
          <button (click)="navegarA('/configuracion')"
            class="p-2 text-slate-400 hover:text-white transition-colors bg-slate-800 rounded-full border border-slate-700 shadow-sm">
            <lucide-icon name="settings" [size]="24"></lucide-icon>
          </button>
          <button (click)="onLogout()"
            class="p-2 text-slate-400 hover:text-red-400 transition-colors bg-slate-800 rounded-full border border-slate-700 shadow-sm">
            <lucide-icon name="logOut" [size]="24"></lucide-icon>
          </button>
        </div>
      </div>

      <!-- Enhanced Financial Summary Badge - CLICKEABLE -->
      <div (click)="navegarA('/finanzas')" class="card-finance mt-4 p-4 cursor-pointer transition-all hover:shadow-md">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <div class="flex items-center justify-center w-10 h-10 rounded-full" style="background: var(--color-info);">
              <lucide-icon name="dollar-sign" [size]="20" style="color: white;"></lucide-icon>
            </div>
            <div class="ml-3">
              <p class="text-label font-medium" style="color: var(--color-text-secondary);">Gasto del Mes</p>
              <p class="text-h2" style="color: var(--color-text-primary); margin-top: 2px;">
                ${{ dashboardData()!.kpis.gastoMes.toLocaleString('es-CO') }}
              </p>
            </div>
          </div>
          <lucide-icon name="chevron-right" [size]="20" style="color: var(--color-info);"></lucide-icon>
        </div>
      </div>
    </div>

    <!-- ========== ALERTS SECTION ========== -->
    @if (dashboardData()!.alertasInsumos.length > 0 || dashboardData()!.alertasPartos.length > 0) {
    <div class="space-y-4">
      <h2 class="text-h2 flex items-center">
        <lucide-icon name="alert-triangle" [size]="22"
          style="color: var(--color-warning); margin-right: 8px;"></lucide-icon>
        Alertas de la Granja
      </h2>

      <!-- Critical Alert - Low Inventory - CLICKEABLE -->
      @if (dashboardData()!.alertasInsumos.length > 0) {
      <div class="card-alert cursor-pointer transition-all hover:shadow-md">
        <button (click)="toggleDetalleInsumos()" class="w-full p-4 text-left flex items-center justify-between"
          style="background: transparent; border: none; cursor: pointer;">
          <div class="flex items-center">
            <div class="flex items-center justify-center w-12 h-12 rounded-full"
              style="background: var(--color-critical);">
              <lucide-icon name="wheat" [size]="24" style="color: white;"></lucide-icon>
            </div>
            <div class="ml-4">
              <h3 class="text-h3">Inventario Bajo</h3>
              <p class="text-small mt-1">
                {{ dashboardData()!.alertasInsumos.length }} insumo(s) requieren atención
              </p>
            </div>
          </div>
          <lucide-icon [name]="mostrarDetalleInsumos() ? 'chevron-up' : 'chevron-down'" [size]="20"
            style="color: var(--color-critical);"></lucide-icon>
        </button>

        <!-- Expandable Detail - Table Format -->
        @if (mostrarDetalleInsumos()) {
        <div class="px-4 pb-4 pt-2 accordion-enter">
          <div class="border-t pt-3" style="border-color: #475569;">
            <!-- Table Header -->
            <div class="grid grid-cols-3 gap-2 mb-2 px-2">
              <span class="text-label font-semibold" style="color: var(--color-text-secondary);">Nombre</span>
              <span class="text-label font-semibold text-right"
                style="color: var(--color-text-secondary);">Actual</span>
              <span class="text-label font-semibold text-right"
                style="color: var(--color-text-secondary);">Mínimo</span>
            </div>
            <!-- Table Rows with Visual Indicators -->
            @for (insumo of dashboardData()!.alertasInsumos; track insumo.id) {
            <div class="alert-table-row grid grid-cols-3 gap-2 rounded" [class.critical]="insumo.stockActual === 0">
              <span class="text-body font-medium" style="color: var(--color-text-primary);">{{ insumo.nombre }}</span>
              <span class="text-body text-right font-semibold"
                [style.color]="insumo.stockActual === 0 ? 'var(--color-critical)' : 'var(--color-text-primary)'">
                {{ insumo.stockActual }} {{ insumo.unidad }}
              </span>
              <span class="text-body text-right" style="color: var(--color-text-secondary);">
                {{ insumo.stockMinimo }}
              </span>
            </div>
            }
            <!-- Action Button -->
            <button (click)="navegarA('/inventario')" class="btn-alert-outline mt-3 w-full">
              Ir a Inventario
            </button>
          </div>
        </div>
        }
      </div>
      }

      <!-- Preventive Alert - Upcoming Births - CLICKEABLE -->
      @if (dashboardData()!.alertasPartos.length > 0) {
      <div class="card-alert warning cursor-pointer transition-all hover:shadow-md">
        <button (click)="toggleDetallePartos()" class="w-full p-4 text-left flex items-center justify-between"
          style="background: transparent; border: none; cursor: pointer;">
          <div class="flex items-center">
            <div class="flex items-center justify-center w-12 h-12 rounded-full"
              style="background: var(--color-warning);">
              <lucide-icon name="baby" [size]="24" style="color: white;"></lucide-icon>
            </div>
            <div class="ml-4">
              <h3 class="text-h3">Partos Próximos</h3>
              <p class="text-small mt-1">
                Partos en los próximos días
              </p>
            </div>
          </div>
          <lucide-icon [name]="mostrarDetallePartos() ? 'chevron-up' : 'chevron-down'" [size]="20"
            style="color: var(--color-warning-dark);"></lucide-icon>
        </button>

        <!-- Expandable Detail - List Format with Badges -->
        @if (mostrarDetallePartos()) {
        <div class="px-4 pb-4 pt-2 accordion-enter">
          <div class="border-t pt-3" style="border-color: var(--color-warning);">
            @for (parto of dashboardData()!.alertasPartos; track parto.chapetaCerda) {
            <div class="alert-table-row flex justify-between items-center rounded mb-1">
              <span class="text-body font-medium" style="color: var(--color-text-primary);">
                Cerda {{ parto.chapetaCerda }}
              </span>
              <div class="flex items-center gap-2">
                <span class="text-body" style="color: var(--color-info);">
                  {{ formatearFechaParto(parto.fechaProbable) }}
                </span>
                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold"
                  [style.background]="parto.diasRestantes <= 2 ? 'var(--color-critical)' : 'var(--color-warning)'"
                  style="color: white;">
                  {{ parto.diasRestantes }}d
                </span>
              </div>
            </div>
            }
            <!-- Action Button -->
            <button (click)="navegarA('/produccion')" class="btn-alert-outline warning mt-3 w-full">
              Ir a Producción
            </button>
          </div>
        </div>
        }
      </div>
      }
    </div>
    }

    <!-- ========== KPI CARDS GRID (DATA FIRST) ========== -->
    <div>
      <h2 class="text-h2 mb-4">Indicadores Clave</h2>
      <div class="grid grid-cols-2 gap-4">

        <!-- 1. Pie de Cría (KPI: Total Cerdas) -->
        <div (click)="navegarA('/produccion')"
          class="bg-slate-800 rounded-2xl p-5 relative overflow-hidden group hover:ring-1 hover:ring-pink-500/50 transition-all cursor-pointer hover:shadow-lg hover:shadow-pink-900/10 active:scale-95">
          <!-- Watermark Icon -->
          <lucide-icon name="piggy-bank" [size]="80"
            class="absolute -bottom-4 -right-4 text-pink-500 opacity-[0.08] group-hover:opacity-20 transition-all duration-500 transform -rotate-12"></lucide-icon>

          <!-- Content -->
          <div class="relative z-10">
            <div
              class="w-8 h-8 rounded-lg bg-pink-500/10 flex items-center justify-center mb-3 group-hover:bg-pink-500/20 transition-colors">
              <lucide-icon name="piggy-bank" [size]="18" class="text-pink-400"></lucide-icon>
            </div>
            <p class="text-4xl font-extrabold text-white tracking-tight">
              {{ dashboardData()!.kpis.totalCerdas }}
            </p>
            <p class="text-sm font-medium text-slate-400 mt-1">Madres Activas</p>
          </div>
        </div>

        <!-- 2. Engorde (KPI: Total Engorde) -->
        <div (click)="navegarA('/lotes')"
          class="bg-slate-800 rounded-2xl p-5 relative overflow-hidden group hover:ring-1 hover:ring-amber-500/50 transition-all cursor-pointer hover:shadow-lg hover:shadow-amber-900/10 active:scale-95">
          <!-- Watermark Icon -->
          <lucide-icon name="wheat" [size]="80"
            class="absolute -bottom-4 -right-4 text-amber-500 opacity-[0.08] group-hover:opacity-20 transition-all duration-500 transform -rotate-12"></lucide-icon>

          <!-- Content -->
          <div class="relative z-10">
            <div
              class="w-8 h-8 rounded-lg bg-amber-500/10 flex items-center justify-center mb-3 group-hover:bg-amber-500/20 transition-colors">
              <lucide-icon name="wheat" [size]="18" class="text-amber-400"></lucide-icon>
            </div>
            <p class="text-4xl font-extrabold text-white tracking-tight">
              {{ dashboardData()!.kpis.totalEngorde }}
            </p>
            <p class="text-sm font-medium text-slate-400 mt-1">En Ceba</p>
          </div>
        </div>

        <!-- 3. Inventario (KPI: Alertas) -->
        <div (click)="navegarA('/inventario')"
          class="bg-slate-800 rounded-2xl p-5 relative overflow-hidden group hover:ring-1 hover:ring-blue-500/50 transition-all cursor-pointer hover:shadow-lg hover:shadow-blue-900/10 active:scale-95">
          <!-- Watermark Icon -->
          <lucide-icon name="package" [size]="80"
            class="absolute -bottom-4 -right-4 text-blue-500 opacity-[0.08] group-hover:opacity-20 transition-all duration-500 transform -rotate-12"></lucide-icon>

          <!-- Content -->
          <div class="relative z-10">
            <div
              class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center mb-3 group-hover:bg-blue-500/20 transition-colors">
              <lucide-icon name="package" [size]="18" class="text-blue-400"></lucide-icon>
            </div>
            @if (dashboardData()!.alertasInsumos.length > 0) {
            <p class="text-4xl font-extrabold text-yellow-400 tracking-tight">
              {{ dashboardData()!.alertasInsumos.length }}
            </p>
            <p class="text-sm font-medium text-slate-400 mt-1">Alertas Stock</p>
            } @else {
            <p class="text-3xl font-extrabold text-emerald-400 tracking-tight">OK</p>
            <p class="text-sm font-medium text-slate-400 mt-1">Stock Sano</p>
            }
          </div>
        </div>

        <!-- 4. Sanidad (KPI: Pendientes) -->
        <div (click)="navegarA('/sanidad')"
          class="bg-slate-800 rounded-2xl p-5 relative overflow-hidden group hover:ring-1 hover:ring-emerald-500/50 transition-all cursor-pointer hover:shadow-lg hover:shadow-emerald-900/10 active:scale-95">
          <!-- Watermark Icon -->
          <lucide-icon name="syringe" [size]="80"
            class="absolute -bottom-4 -right-4 text-emerald-500 opacity-[0.08] group-hover:opacity-20 transition-all duration-500 transform -rotate-12"></lucide-icon>

          <!-- Content -->
          <div class="relative z-10">
            <div
              class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center mb-3 group-hover:bg-emerald-500/20 transition-colors">
              <lucide-icon name="syringe" [size]="18" class="text-emerald-400"></lucide-icon>
            </div>
            <p class="text-4xl font-extrabold text-white tracking-tight"
              [class.text-red-400]="tareasPendientesCount() > 0">
              {{ tareasPendientesCount() }}
            </p>
            <p class="text-sm font-medium text-slate-400 mt-1">Pendientes</p>
          </div>
        </div>

      </div>
    </div>

    <!-- ========== QUICK ACTIONS ========== -->
    <div>
      <h2 class="text-h2 mb-4">Acciones Rápidas</h2>
      <div class="space-y-3">

        <button (click)="navegarA('/finanzas')" class="btn btn-primary w-full py-4 text-base">
          <lucide-icon name="dollar-sign" [size]="20" class="mr-2"></lucide-icon>
          Registrar Gasto
        </button>

        <button (click)="navegarA('/produccion')" class="btn btn-secondary w-full py-4 text-base">
          <lucide-icon name="alert-triangle" [size]="20" class="mr-2"></lucide-icon>
          Registrar Evento
        </button>

      </div>
    </div>

  </div>
  }

  <!-- Logout Confirmation Modal -->
  @if (showLogoutConfirm()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm fade-in"
    (click)="showLogoutConfirm.set(false)">
    <div
      class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-700 p-6 animate-in zoom-in-95 duration-200"
      (click)="$event.stopPropagation()">
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0 w-12 h-12 bg-red-900/20 rounded-full flex items-center justify-center">
          <lucide-icon name="logOut" [size]="24" class="text-red-400"></lucide-icon>
        </div>
        <div class="flex-1">
          <h3 class="text-lg font-bold text-white mb-2">Cerrar Sesión</h3>
          <p class="text-sm text-slate-300">¿Estás seguro que deseas salir de la aplicación?</p>
        </div>
      </div>

      <div class="flex gap-3 mt-6">
        <button (click)="showLogoutConfirm.set(false)"
          class="flex-1 py-2.5 px-4 bg-slate-700 text-white font-medium rounded-lg hover:bg-slate-600 transition-colors">
          Cancelar
        </button>
        <button (click)="confirmLogout()"
          class="flex-1 py-2.5 px-4 bg-red-600 text-white font-medium rounded-lg hover:bg-red-500 transition-colors">
          Salir
        </button>
      </div>
    </div>
  </div>
  }
</div>