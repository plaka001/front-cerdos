-----Database Functions

calcular_promedio_ponderado: 

DECLARE
    v_stock_actual numeric;
    v_costo_actual numeric;
    v_cantidad_ingresada numeric;
    v_factor_conversion numeric;
    v_nuevo_costo numeric;
BEGIN
    -- Obtenemos datos actuales
    SELECT stock_actual, costo_promedio, presentacion_compra 
    INTO v_stock_actual, v_costo_actual, v_factor_conversion
    FROM insumos WHERE id = NEW.insumo_id;

    -- Calculamos kilos reales
    v_cantidad_ingresada := NEW.cantidad_comprada * v_factor_conversion;
    NEW.cantidad_real_ingresada := v_cantidad_ingresada;
    
    -- Evitar divisiÃ³n por cero
    IF v_cantidad_ingresada > 0 THEN
        NEW.precio_unitario_final := NEW.precio_total_factura / v_cantidad_ingresada;
    ELSE
        NEW.precio_unitario_final := 0;
    END IF;

    -- Calcular nuevo costo promedio ponderado
    IF (v_stock_actual + v_cantidad_ingresada) > 0 THEN
        v_nuevo_costo := ((v_stock_actual * v_costo_actual) + NEW.precio_total_factura) / 
                        (v_stock_actual + v_cantidad_ingresada);
    ELSE
        v_nuevo_costo := v_costo_actual;
    END IF;

    -- Actualizamos Insumo con nuevo precio promedio
    UPDATE insumos
    SET 
        costo_promedio = v_nuevo_costo,
        stock_actual = stock_actual + v_cantidad_ingresada
    WHERE id = NEW.insumo_id;

    RETURN NEW;
END;

restar_inventario: 
BEGIN
    UPDATE insumos
    SET stock_actual = GREATEST(0, stock_actual - NEW.cantidad)
    WHERE id = NEW.insumo_id;
    RETURN NEW;
END;


-----Database Functions End-----

-----Database Triggers-----

CREATE TRIGGER trg_actualizar_inventario_compra
BEFORE INSERT ON compras_insumos
FOR EACH ROW EXECUTE FUNCTION calcular_promedio_ponderad

CREATE TRIGGER trg_restar_inventario_salida
AFTER INSERT ON salidas_insumos
FOR EACH ROW EXECUTE FUNCTION restar_inventario();

---- Database Triggers End----

-- Enums 
public

tipo_insumo	alimento:, medicamento, biologico, material, otro	

public

unidad_medida:	kg, gr, ml, dosis, unidad, bulto	

public

estado_cerda:	vacia, gestante, lactante, descarte	

public

estado_lote:	activo, cerrado_vendido	

public

tipo_flujo:	operativo, inversion, administrativo
---- Enums End----


---tablas---

-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.categorias_financieras (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  nombre text NOT NULL,
  tipo USER-DEFINED NOT NULL,
  descripcion text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT categorias_financieras_pkey PRIMARY KEY (id)
);
CREATE TABLE public.cerdas (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  chapeta text NOT NULL UNIQUE,
  fecha_nacimiento date,
  raza text,
  estado USER-DEFINED DEFAULT 'vacia'::estado_cerda,
  partos_acumulados integer DEFAULT 0,
  activa boolean DEFAULT true,
  notas text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT cerdas_pkey PRIMARY KEY (id)
);
CREATE TABLE public.ciclos_reproductivos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  cerda_id bigint,
  fecha_inseminacion date,
  padre_semen text,
  costo_servicio numeric DEFAULT 0,
  fecha_parto_probable date,
  fecha_parto_real date,
  nacidos_vivos integer DEFAULT 0,
  nacidos_muertos integer DEFAULT 0,
  momias integer DEFAULT 0,
  fecha_destete date,
  lechones_destetados integer DEFAULT 0,
  peso_promedio_destete numeric,
  estado text DEFAULT 'abierto'::text,
  created_at timestamp with time zone DEFAULT now(),
  observaciones text,
  CONSTRAINT ciclos_reproductivos_pkey PRIMARY KEY (id),
  CONSTRAINT ciclos_reproductivos_cerda_id_fkey FOREIGN KEY (cerda_id) REFERENCES public.cerdas(id)
);
CREATE TABLE public.compras_insumos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  fecha date DEFAULT CURRENT_DATE,
  insumo_id bigint,
  proveedor text,
  cantidad_comprada numeric NOT NULL,
  cantidad_real_ingresada numeric,
  precio_total_factura numeric NOT NULL,
  precio_unitario_final numeric,
  numero_factura text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT compras_insumos_pkey PRIMARY KEY (id),
  CONSTRAINT compras_insumos_insumo_id_fkey FOREIGN KEY (insumo_id) REFERENCES public.insumos(id)
);
CREATE TABLE public.eventos_sanitarios (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  fecha date DEFAULT CURRENT_DATE,
  tipo text CHECK (tipo = ANY (ARRAY['muerte'::text, 'enfermedad'::text, 'tratamiento'::text])),
  lote_id bigint,
  cerda_id bigint,
  cantidad_afectada integer DEFAULT 1,
  observacion text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT eventos_sanitarios_pkey PRIMARY KEY (id),
  CONSTRAINT eventos_sanitarios_lote_id_fkey FOREIGN KEY (lote_id) REFERENCES public.lotes(id),
  CONSTRAINT eventos_sanitarios_cerda_id_fkey FOREIGN KEY (cerda_id) REFERENCES public.cerdas(id)
);
CREATE TABLE public.insumos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  nombre text NOT NULL,
  tipo USER-DEFINED NOT NULL,
  unidad_medida_uso USER-DEFINED NOT NULL DEFAULT 'kg'::unidad_medida,
  presentacion_compra numeric DEFAULT 40,
  stock_actual numeric DEFAULT 0,
  costo_promedio numeric DEFAULT 0,
  stock_minimo numeric DEFAULT 5,
  activo boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT insumos_pkey PRIMARY KEY (id)
);
CREATE TABLE public.lote_origen (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  lote_id bigint,
  ciclo_id bigint,
  cantidad_aportada integer,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT lote_origen_pkey PRIMARY KEY (id),
  CONSTRAINT lote_origen_lote_id_fkey FOREIGN KEY (lote_id) REFERENCES public.lotes(id),
  CONSTRAINT lote_origen_ciclo_id_fkey FOREIGN KEY (ciclo_id) REFERENCES public.ciclos_reproductivos(id)
);
CREATE TABLE public.lotes (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  codigo text NOT NULL UNIQUE,
  fecha_inicio date DEFAULT CURRENT_DATE,
  fecha_cierre date,
  ubicacion text DEFAULT 'precebo'::text,
  cantidad_inicial integer NOT NULL,
  cantidad_actual integer NOT NULL,
  costo_inicial_lote numeric DEFAULT 0,
  estado USER-DEFINED DEFAULT 'activo'::estado_lote,
  created_at timestamp with time zone DEFAULT now(),
  peso_promedio_inicial numeric DEFAULT 0,
  observaciones text,
  peso_promedio_actual numeric DEFAULT 0,
  CONSTRAINT lotes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.movimientos_caja (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  fecha date DEFAULT CURRENT_DATE,
  tipo text CHECK (tipo = ANY (ARRAY['ingreso'::text, 'egreso'::text])),
  categoria_id bigint,
  monto numeric NOT NULL,
  descripcion text,
  metodo_pago text DEFAULT 'efectivo'::text,
  lote_relacionado_id bigint,
  url_comprobante text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT movimientos_caja_pkey PRIMARY KEY (id),
  CONSTRAINT movimientos_caja_categoria_id_fkey FOREIGN KEY (categoria_id) REFERENCES public.categorias_financieras(id),
  CONSTRAINT movimientos_caja_lote_relacionado_id_fkey FOREIGN KEY (lote_relacionado_id) REFERENCES public.lotes(id)
);
CREATE TABLE public.salidas_insumos (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  fecha date DEFAULT CURRENT_DATE,
  insumo_id bigint,
  cantidad numeric NOT NULL,
  destino_tipo text CHECK (destino_tipo = ANY (ARRAY['lote'::text, 'cerda'::text, 'general'::text])),
  lote_id bigint,
  cerda_id bigint,
  costo_unitario_momento numeric NOT NULL,
  costo_total_salida numeric DEFAULT (cantidad * costo_unitario_momento),
  notas text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT salidas_insumos_pkey PRIMARY KEY (id),
  CONSTRAINT salidas_insumos_insumo_id_fkey FOREIGN KEY (insumo_id) REFERENCES public.insumos(id),
  CONSTRAINT salidas_insumos_lote_id_fkey FOREIGN KEY (lote_id) REFERENCES public.lotes(id),
  CONSTRAINT salidas_insumos_cerda_id_fkey FOREIGN KEY (cerda_id) REFERENCES public.cerdas(id)
);
----tablas end----